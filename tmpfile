package com.storefit.catalog_service.Controller;

import com.storefit.catalog_service.Model.Producto;
import com.storefit.catalog_service.Model.ProductoId;
import com.storefit.catalog_service.Service.ProductoService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.net.URI;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/v1/productos")
@RequiredArgsConstructor
public class ProductoController {

    private final ProductoService service;

    @Operation(summary = "Listar productos", description = "Obtiene todos los productos del catálogo")
    @ApiResponses({
        @ApiResponse(responseCode = "200", description = "OK",
            content = @Content(schema = @Schema(implementation = Producto.class)))
    })
    @GetMapping
    public ResponseEntity<List<Producto>> all() {
        return ResponseEntity.ok(service.findAll());
    }

    @Operation(summary = "Obtener producto por ID compuesto",
            description = "Busca un producto por (id_categoria, id_producto)")
    @ApiResponses({
        @ApiResponse(responseCode = "200", description = "Encontrado",
            content = @Content(schema = @Schema(implementation = Producto.class))),
        @ApiResponse(responseCode = "404", description = "No encontrado")
    })
    @GetMapping("/{categoriaId}/{productoId}")
    public ResponseEntity<Producto> byId(@PathVariable Long categoriaId, @PathVariable Long productoId) {
        return ResponseEntity.ok(service.findByIds(categoriaId, productoId));
    }

    @Operation(summary = "Listar productos por categoría",
            description = "Devuelve los productos pertenecientes a la categoría indicada")
    @ApiResponses({
        @ApiResponse(responseCode = "200", description = "OK",
            content = @Content(schema = @Schema(implementation = Producto.class)))
    })
    @GetMapping("/categoria/{categoriaId}")
    public ResponseEntity<List<Producto>> byCategoria(@PathVariable Long categoriaId) {
        return ResponseEntity.ok(service.findByCategoria(categoriaId));
    }

    @Operation(summary = "Crear producto",
            description = "Crea un nuevo producto con id compuesto (id_categoria + id_producto). Requiere que la categoría exista.")
    @ApiResponses({
        @ApiResponse(responseCode = "201", description = "Creado",
            content = @Content(schema = @Schema(implementation = Producto.class))),
        @ApiResponse(responseCode = "400", description = "Datos inválidos"),
        @ApiResponse(responseCode = "404", description = "Categoría no encontrada"),
        @ApiResponse(responseCode = "409", description = "Producto duplicado")
    })
    @PostMapping
    public ResponseEntity<Map<String, Object>> create(@Valid @RequestBody Producto p) {
        var created = service.create(p);
        ProductoId id = created.getId();
        var location = URI.create("/api/v1/productos/" + id.getIdCategoria() + "/" + id.getIdProducto());
        return ResponseEntity.created(location).body(
            Map.of(
                "message", "Producto añadido correctamente",
                "data", created
            )
        );
    }

    @Operation(summary = "Actualizar producto",
            description = "Actualiza los datos del producto identificado por id_categoria e id_producto")
    @ApiResponses({
        @ApiResponse(responseCode = "200", description = "Actualizado",
            content = @Content(schema = @Schema(implementation = Producto.class))),
        @ApiResponse(responseCode = "400", description = "Datos inválidos"),
        @ApiResponse(responseCode = "404", description = "No encontrado")
    })
    @PutMapping("/{categoriaId}/{productoId}")
    public ResponseEntity<Map<String, Object>> update(
            @PathVariable Long categoriaId,
            @PathVariable Long productoId,
            @Valid @RequestBody Producto p) {

        var updated = service.update(categoriaId, productoId, p);
        return ResponseEntity.ok(
            Map.of(
                "message", "Producto actualizado correctamente",
                "data", updated
            )
        );
    }

    @Operation(summary = "Eliminar producto",
            description = "Elimina el producto identificado por id_categoria e id_producto")
    @ApiResponses({
        @ApiResponse(responseCode = "200", description = "Eliminado"),
        @ApiResponse(responseCode = "404", description = "No encontrado")
    })
    @DeleteMapping("/{categoriaId}/{productoId}")
    public ResponseEntity<Map<String, String>> delete(@PathVariable Long categoriaId, @PathVariable Long productoId) {
        service.delete(categoriaId, productoId);
        return ResponseEntity.ok(
            Map.of("message", "Producto eliminado correctamente")
        );
    }
}
